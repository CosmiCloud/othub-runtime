<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />

    <title>otnode.com</title>
    <meta content="" name="description" />
    <meta content="" name="keywords" />

    <!-- Favicons -->
    <link href="images/favicon.png" rel="icon" />
    <link href="images/apple-touch-icon.png" rel="apple-touch-icon" />

    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Raleway:300,300i,400,400i,500,500i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i"
      rel="stylesheet"
    />

    <!-- Vendor CSS Files -->
    <link href="/vendor/aos/aos.css" rel="stylesheet" />
    <link href="/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
    <link href="/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet" />
    <link href="/vendor/boxicons/css/boxicons.min.css" rel="stylesheet" />
    <link href="/vendor/glightbox/css/glightbox.min.css" rel="stylesheet" />
    <link href="/vendor/remixicon/remixicon.css" rel="stylesheet" />
    <link href="/vendor/swiper/swiper-bundle.min.css" rel="stylesheet" />

    <!-- Template Main CSS File -->
    <link href="/public/stylesheets/style.css" rel="stylesheet" />
    <link rel="stylesheet" href="/stylesheets/style.css" type="text/css" />
    <link rel="stylesheet" href="/stylesheets/style.scss" type="text/css" />
    <link rel="stylesheet" href="/javascripts/main.js" type="text/css" />

    <!-- =======================================================
  * Template Name: OnePage - v4.7.0
  * Template URL: https://bootstrapmade.com/onepage-multipurpose-bootstrap-template/
  * Author: BootstrapMade.com
  * License: https://bootstrapmade.com/license/
  ======================================================== -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    let chat_id = '<%- locals.chat_id %>'
    let ual = '<%- locals.ual %>'
    let username = '<%- locals.username %>'
    let owner = '<%- locals.owner_address %>'
    let knowledge = '<%- locals.knowledge %>'
    let item_inventory = '<%- locals.inventory %>'
    let explores = '<%- locals.explores %>'
    let treks = '<%- locals.treks %>'
    let isok_account = '<%- locals.isok_account %>'
    let focus_item = '<%- locals.focus_item %>'

    let owner_address = localStorage.getItem('owner_address');
    let chain_id = localStorage.getItem('chain_id');

    console.log('OWNER:'+ '<%- locals.owner %>')
  </script>
  </head>

  <body>
    <!-- ======= Header ======= -->
    <header style="background: none;">
      <div class="d-flex align-items-center justify-content-between" style="padding-top:10px;">
        <a href="/search" style="color: #6168ed;margin-left:2.5%;font-size:28px;font-family: OCR A Std, monospace;">otnode.com</a>
        <div class="form-group" style="margin-left: 80px;">
          <div class="input-group" style="white-space:nowrap;" id="searchbar">

          </div>
        </div>

        <nav id="navbar" class="navbar">
          <ul>
            <li id="MM">

            </li>
            <li id="explore">

            </li>
          </ul>
        </nav>
        <!-- .navbar -->
      </div>
    </header>
    <html>
  </body>
    </html>
    <!-- End Header -->
    <main id="main" style="height: calc(90vh);">

      <section id="hero" style="height:100%;">
        <div id="dashboard">
          <div id="row1" class="d-flex"></div>
          <div id="row2" class="d-flex"></div>


        </div>

      </section>
      <!-- <form id="owner_login_form" action="/isok/account" method="GET">
        <input type="text" name="ual" id="ual" style="display:none;" value=""></input>
      </form> -->
      <form id="post_publish_refresh" action="/isok/account" method="POST">
        <input type="text" name="keywords" id="_keywords" style="display:none;" value=""></input>
        <input type="text" name="ual" id="_ual" style="display:none;" value=""></input>
        <!--<input type="text" name="account_ual" id="_account_ual" style="display:none;" value=""></input>-->
        <input type="text" name="epochs" id="_epochs" style="display:none;" value=""></input>
        <input type="text" name="owner_address" id="_owner_address" style="display:none;" value=""></input>
        <input type="text" name="txn_id" id="_txn_id" style="display:none;" value=""></input>
        <input type="text" name="assertionId" id="_assertionId" style="display:none;" value=""></input>
        <input type="text" name="operationId" id="_operationId" style="display:none;" value=""></input>
        <input type="text" name="fee" id="_fee" style="display:none;" value=""></input>
        <input type="text" name="assetData" id="_assetData" style="display:none;" value=""></input>
        <input type="text" name="type" id="_type" style="display:none;" value=""></input>
        <input type="text" name="action" id="_action" style="display:none;" value=""></input>
      </form>
      <form id="first_sign_refresh" action="/isok/isokTransactions" method="GET">
        <input type="text" name="owner_address" id="owner_address" style="display:none;" value=""></input>
      </form>
    </main>
    <!-- End #main -->

    <!-- ======= Footer ======= -->
    <!-- <footer style="position: fixed; bottom: 0; width: 100%;background:none;">
      <div class="container d-md-flex py-4">

        </div>
      </div>
    </footer> -->
    <!-- End Footer -->

    <!-- Vendor JS Files -->
    <script src="vendor/purecounter/purecounter.js"></script>
    <script src="vendor/aos/aos.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="vendor/glightbox/js/glightbox.min.js"></script>
    <script src="vendor/isotope-layout/isotope.pkgd.min.js"></script>
    <script src="vendor/swiper/swiper-bundle.min.js"></script>
    <script src="vendor/php-email-form/validate.js"></script>

    <!-- Template Main JS File -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="/javascripts/account.js"></script>
    <script>
      nav(owner_address, chain_id);

      if(owner != owner_address){
        blank_page();
      }else{
        if(isok_account){
          inventory(item_inventory,username,ual,owner_address);

          if(focus_item){
            item_focus(focus_item);
          }else{
            item_view();
          }
        }else{
          blank_page();
        }
      }
    </script>
    <script>
      console.log('1: '+item_inventory)
      if(knowledge && item_inventory){
        build_local_items(item_inventory);
        knowledge_html(knowledge);
      }

      function change_owner_button(type) {
        document.getElementById(type).checked = 'checked';
        if(type == 'host'){
            build_local_items(item_inventory);
            var new_hostbutton=`<button type="button" id="host_button" onclick="change_owner_button('host')" style="border-radius:5px 0px 0px 5px;background-color:#6168ED;padding:3px 10px;font-size:12px;border:none;">Local</button>`;
            var new_selfbutton=`<button type="button" id="self_button" onclick="change_owner_button('self')" style="border-radius:0px 5px 5px 0px;background-color:#ffffff;color:#6168ED;border: 1px solid #6168ED;padding:3px 10px;font-size:12px;">Minted</button>`;
        }else{
            build_minted_items(item_inventory);
            var new_selfbutton=`<button type="button" id="host_button" onclick="change_owner_button('self')" style="border-radius:0px 5px 5px 0px;background-color:#6168ED;padding:3px 10px;font-size:12px;border:none;">Minted</button>`;
            var new_hostbutton=`<button type="button" id="self_button" onclick="change_owner_button('host')" style="border-radius:5px 0px 0px 5px;background-color:#ffffff;color:#6168ED;border: 1px solid #6168ED;padding:3px 10px;font-size:12px;">Local</button>`;
        }

        document.getElementById("host_button").remove();
        document.getElementById("self_button").remove();
        $('#owner_buttons').append(new_hostbutton);
        $('#owner_buttons').append(new_selfbutton);
        }

        if(document.getElementById('host')){
          if(document.getElementById('host').checked == 'checked'){
          var new_selfbutton=`<button type="button" id="host_button" onclick="change_owner_button('host')" style="border-radius:5px 0px 0px 5px;background-color:#6168ED;padding:3px 10px;font-size:12px;border:none;">Minted</button>`;
              var new_hostbutton=`<button type="button" id="self_button" onclick="change_owner_button('self')" style="border-radius:0px 5px 5px 0px;background-color:#ffffff;color:#6168ED;border: 1px solid #6168ED;padding:3px 10px;font-size:12px;">Local</button>`;
              $('#owner_buttons').append(new_hostbutton);
              $('#owner_buttons').append(new_selfbutton);
          }else{
              var new_hostbutton=`<button type="button" id="host_button" onclick="change_owner_button('host')" style="border-radius:5px 0px 0px 5px;background-color:#6168ED;padding:3px 10px;font-size:12px;border:none;">Local</button>`;
              var new_selfbutton=`<button type="button" id="self_button" onclick="change_owner_button('self')" style="border-radius:0px 5px 5px 0px;background-color:#ffffff;color:#6168ED;border: 1px solid #6168ED;padding:3px 10px;font-size:12px;">Minted</button>`;

              $('#owner_buttons').append(new_hostbutton);
              $('#owner_buttons').append(new_selfbutton);
          }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js" type="application/javascript"></script>
    <script src="/dkg.js/dist/dkg.min.js"></script>
    <script src="/javascripts/metamask.js"></script>
    <script>
      async function sendPublish(){
        try{
            getAccountRefresh();
            document.getElementById("mintButton").style.display = "none";

            let activeChainId;
            let txn_id;
            let keywords;
            let fee;
            let epochs;
            let type;
            let assetData;
            let chain;
            
            activeChainId = localStorage.getItem("activeChainId")
            fee = document.getElementById("trac_fee").value
            epochs = document.getElementById("epochs").value
            type = document.getElementById("type").value
            action = "item creation"
            
            function isJsonString(str) {
                try {
                    JSON.parse(str);
                } catch (e) {
                    return 'false';
                }
                return 'true';
            }
            
            valid_json = await isJsonString(document.getElementById("item_data").value);
            if(valid_json == 'false'){
              console.log(`Invalid JSON.`)
              document.getElementById("invalid_json").style.display = "block";
              return
            }

            document.getElementById("invalid_json").style.display = "none";
            assetData = JSON.parse(document.getElementById("item_data").value)
            assetData["account"] = ual
            assetData["owner"] = owner_address
            assetData["quantity"] = 1
            keywords = assetData.name
            assetData["@context"] = "https://schema.org"
            assetData["@type"] = "Game"

            console.log(`ITEM DATA: ${JSON.stringify(assetData)}`)
            
            if (!activeChainId){
                console.log("No active chain id.")
                document.getElementById("invalid_chain").style.display = "block";
                return;
            }

            if (activeChainId === '0x4fce'){
                chain = `otp::testnet`
                ot_node_hostname = `https://www.otnode.com`
                node_port= `8900`
            }

            if (activeChainId === '20430'){
                chain = `otp::mainnet`
                ot_node_hostname = `https://www.otnode.com`
                node_port= `8901`
            }

            if(!chain){
              console.log(`Unsupported network: ${activeChainId}`)
              document.getElementById("invalid_chain").style.display = "block";
              return;
            }
            
            if(!keywords){
              keywords = `otnodedotcom`
            }else{
              keywords = keywords.replace("'", "");
              keywords = keywords.replace('"', "");
              keywords = keywords + ",in search of knowledge, game, item";
            }

            if(!epochs){
              epochs = 200
            }

            if(!fee){
              publishOptions= {
                  epochsNum: epochs,
                  maxNumberOfRetries: 30,
                  frequency: 1,
                  keywords: keywords,
                  blockchain : {
                      name: chain,
                  }
              }
            }else{
              publishOptions= {
                  epochsNum: epochs,
                  maxNumberOfRetries: 30,
                  frequency: 1,
                  tokenAmount: ethers.utils.parseEther(fee),
                  keywords: keywords,
                  blockchain : {
                      name: chain,
                  }
              }
            }

          const options = {
              endpoint: ot_node_hostname,
              port: node_port,
              useSSL: false,
          };

          window.DkgClient = new DKG(options);
          console.log("client initialized")

          minted_asset = await DkgClient.asset.create(assetData,publishOptions)
              .then(result => {
                  console.log({ assertionId: result.assertionId, UAL: result.UAL })
                  return result;
              });


          document.getElementById("_keywords").value = keywords;
          document.getElementById("_fee").value = fee;
          document.getElementById("_epochs").value = epochs;
          document.getElementById("_ual").value = minted_asset.UAL;
          document.getElementById("_assertionId").value = minted_asset.assertionId;
          document.getElementById("_operationId").value = minted_asset.operationId;
          document.getElementById("_assetData").value = JSON.stringify(assetData);
          document.getElementById("_owner_address").value = owner_address;
          document.getElementById("post_publish_refresh").submit();  
        }catch(e){
          document.getElementById("mintButton").style.display = "block";
        }
      }
  </script>
  </body>
</html>
